{% extends 'users/base.html' %}
{% load static %}
{% block body %}

<div class="flex justify-center mt-10 mb-6">
  <h2 class="text-4xl font-bold text-purple-600 tracking-tight">Feed</h2>
</div>

<div class="flex flex-col items-center space-y-12 px-4 pb-24">
  {% for post in posts %}
  <div
    class="bg-white rounded-2xl shadow-md hover:shadow-2xl transition-all duration-300 w-full max-w-xl border border-gray-100">

    <!-- user info -->
    <div class="flex flex-col items-center py-6 border-b">
      <img class="w-20 h-20 rounded-full object-cover border-2 border-purple-300"
        src="{% if post.user.profile.photo %}{{ post.user.profile.photo.url }}{% else %}{% static 'users/images/default-profile.png' %}{% endif %}"
        alt="{{ post.user.username }}">
      <p class="mt-3 font-semibold text-lg text-gray-800">{{ post.user.username }}</p>
      <p class="text-gray-400 text-sm">{{ post.created_at|date:"M d, Y" }}</p>
    </div>

    <!-- post image -->
    <div class="w-full h-[420px] bg-gray-100 flex justify-center items-center">
      {% if post.image %}
      <img src="{{ post.image.url }}" alt="Post Image"
        class="h-full w-full object-cover hover:scale-105 transition-transform duration-500">
      {% else %}
      <span class="text-gray-400 italic">No image uploaded</span>
      {% endif %}
    </div>

    <!-- post actions -->
    <div class="flex items-center space-x-6 px-6 py-4">
      <a id="{{ post.id }}" class="btn-like">
        {% if logged_user in post.liked_by.all %}
        <img src="{% static 'users/images/red.png' %}" alt="Like"
          class="w-7 h-7 cursor-pointer hover:scale-110 transition-transform">
        {% else %}
        <img src="{% static 'users/images/white.png' %}" alt="Like"
          class="w-7 h-7 cursor-pointer hover:scale-110 transition-transform">
        {% endif %}
      </a>
      <img src="{% static 'users/images/comment.png' %}" alt="Comment"
        class="w-7 h-7 cursor-pointer hover:scale-110 transition-transform">
      <img src="{% static 'users/images/share.png' %}" alt="Share"
        class="w-7 h-7 cursor-pointer hover:scale-110 transition-transform">
    </div>

    <!-- comments -->
    <div class="px-6 py-4 border-t">
      {% for comment in post.comments.all %}
      <p class="text-gray-700 text-sm mb-1">ðŸ’¬ <b>{{ comment.posted_by }} </b>:{{ comment.body }}</p>
      {% endfor %}
    </div>

    <!-- add comment form -->
    <div class="px-6 py-5 border-t bg-blue-50">
      <form method="POST" class="flex flex-col space-y-3">
        {% csrf_token %}
        <label class="text-sm text-gray-600 font-medium">Add Comment</label>
        <div class="w-full">
       {{ comment_form.body }}
        </div>
        <input type="hidden" name="post_id" id="post_id" value="{{ post.id }}">
        <input type="hidden" name="posted_by" id="posted_by" value="{{ logged_user }}">
        <button type="submit"
          class="self-end bg-purple-600 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-purple-700 transition">
          Add
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

{% if user.is_authenticated %}
<div class="fixed bottom-0 left-0 w-full bg-white border-t shadow-lg">
  <div class="max-w-4xl mx-auto flex items-center justify-around py-3">

    <!-- Home Button -->
    <a href="{% url 'index' %}" class="flex flex-col items-center text-gray-600 hover:text-purple-600 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mb-1" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M3 9.75L12 3l9 6.75V21a1.5 1.5 0 01-1.5 1.5h-15A1.5 1.5 0 013 21V9.75z" />
      </svg>
      <span class="text-xs font-medium">Home</span>
    </a>

    <!-- Post Button -->
    <a href="{% url 'create' %}" class="flex flex-col items-center text-purple-600 hover:text-purple-800 transition">
      <img src="{% static 'users/images/post.png' %}" alt="Post" class="h-8 w-8 mb-1 object-contain">
      <span class="text-xs font-medium">Post</span>
    </a>
  </div>
</div>
{% endif %}

<script type="text/javascript">
  window.CSRF_TOKEN = "{{ csrf_token }}"
  $(document).on('click', '.btn-like', function () {
    var post_id = this.id
    $.ajax({
      method: "POST",
      url: '/posts/like',
      data: { post_id: post_id, csrfmiddlewaretoken: window.CSRF_TOKEN },
    })
    window.location.href = "http://localhost:8000/posts/feed/"
  })
</script>

{% endblock %}