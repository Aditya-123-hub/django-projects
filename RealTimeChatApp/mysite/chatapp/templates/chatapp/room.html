{% extends 'chatapp/base.html' %}
{% block body %}
<!-- Display current chatroom name -->
{{ chatroom.name }}

<!-- Div where chat messages will appear -->
<div id="chat-messages">
    {% for message in messages %}
    {{ message.user.username }} : {{ message.message_content }}<br>
    {% endfor %}
</div>

<!-- Form to send a new message -->
<form method="POST">
    {% csrf_token %}
    <input id="message-input" type="text" name="message" placeholder="Enter message">
    <button id="send-button" type="submit">Send</button>
</form>

<!-- Pass chatroom slug and username safely to JS -->
{{ chatroom.slug|json_script:"json-chatroomname" }}



<script>
    // Parse chatroom name and username from template
    const ChatRoomName = JSON.parse(document.getElementById('json-chatroomname').textContent);
    const username = "guest_user"
    console.log("Current User:", username) // debug

    // Create WebSocket connection to server
    const ChatSocket = new WebSocket(
        (window.location.protocol === "https:" ? "wss://" : "ws://") 
        + window.location.host 
        + '/ws/' + ChatRoomName + '/'
    );

    // Handle incoming messages from server
    ChatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data)
        if (data.message) {
            const chatBox = document.getElementById('chat-messages');
            const newMessage = document.createElement('div');
            newMessage.textContent = data.username + " : " + data.message;
            chatBox.appendChild(newMessage);
        }
    };

    ChatSocket.onclose = function(e) {
        console.log('socket closed');
    };

    // Enable send button only after connection is open ✅
    ChatSocket.onopen = function(e) {
        console.log("WebSocket connected ✅");

        document.getElementById('send-button').onclick = function(e) {
            e.preventDefault();  // prevent form reload
            const MessageInput = document.getElementById('message-input');
            const message = MessageInput.value;

            if (message.trim() !== "") {
                ChatSocket.send(JSON.stringify({
                    'message': message,
                    'username': username,
                    'room': ChatRoomName,
                }));
                MessageInput.value = "";
            }
        }
    };
</script>

{% endblock %}
